#!/usr/bin/env php
<?php
declare(strict_types = 1);

$paths = [
    __DIR__.'/vendor/autoload.php',
    __DIR__ . '/../../../vendor/autoload.php',
];

foreach ($paths as $file) {
    if (file_exists($file)) {
        require $file;
        break;
    }
}

use Halsey\Journal\{
    Command\Preview,
    Generate,
    Render,
    RewriteUrl,
    Templating,
};
use Innmind\CLI\Framework\{
    Main,
    Application,
};
use function Innmind\Templating\bootstrap;
use Innmind\Url\Path;
use Innmind\Immutable\Map;

new class extends Main {
    protected function configure(Application $app): Application
    {
        return $app
            ->service('rewrite_url', static fn() => new RewriteUrl)
            ->service('templating', static fn($env, $os, $service) => bootstrap(
                Path::of(__DIR__.'/templates/'),
                null,
                Map::of('string', 'object')
                    ('helper', new Templating\Helper($service('rewrite_url'))),
            ))
            ->service('render', static fn($env, $os, $service) => new Render\All(
                new Render\Markdown(
                    $service('rewrite_url'),
                    $service('templating'),
                ),
                new Render\AddStaticFiles($os, Path::of(__DIR__.'/')),
            ))
            ->service('generate', static fn($env, $os, $service) => new Generate(
                $os,
                $service('render'),
            ))
            ->service('preview', static fn($env, $os, $service) => new Preview(
                $os,
                $service('generate'),
            ))
            ->command('preview');
    }
};
